services:
    dico-db:
        image: mongo:6.0
        container_name: dico-mongodb
        environment:
            - MONGO_INITDB_DATABASE=dico-db
        ports:
            - "27027:27017"
        healthcheck:
            test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
            interval: 10s
            timeout: 5s
            retries: 5
            start_period: 20s

    dico:
        build:
            context: .
            dockerfile: Dockerfile
        container_name: dico
        ports:
            - "4242:4242"
        depends_on:
            dico-db:
                condition: service_healthy
        environment:
            - MONGO_URI=mongodb://dico-db:27017/dico-db
            - MONGO_DB=dico-db

    populate:
        profiles: [first-start]
        build:
            context: .
            dockerfile: Dockerfile.populate
        depends_on:
            dico-db:
                condition: service_healthy
        environment:
            - MONGO_URI=mongodb://dico-db:27017/dico-db
            - MONGO_DB=dico-db
        restart: "no"
